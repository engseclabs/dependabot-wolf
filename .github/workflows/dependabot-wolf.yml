name: Dependabot Wolf
on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight
  workflow_dispatch:

jobs:
  call-copilot:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPENDABOT_PAT }}
          script: |
            // Get all Dependabot alerts
            const alerts = await github.rest.dependabot.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            // Get all open PRs
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            // Find stuck alerts (alerts without Dependabot PRs)
            const stuckAlerts = alerts.data.filter(alert => {
              const pkg = alert.dependency.package.name;
              return !prs.data.some(pr =>
                pr.user.login === 'dependabot[bot]' && pr.title.includes(pkg)
              );
            });

            if (stuckAlerts.length === 0) {
              console.log('No stuck alerts');
              return;
            }

            console.log(`Found ${stuckAlerts.length} stuck alerts`);

            // For each stuck alert, create an issue if one doesn't exist
            for (const alert of stuckAlerts) {
              const cve = alert.security_advisory.cve_id || alert.security_advisory.ghsa_id;
              const pkg = alert.dependency.package.name;

              // Check if issue already exists
              const existing = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'dependabot-wolf'
              });

              if (existing.data.some(issue => issue.title.includes(cve))) {
                console.log(`Issue already exists for ${cve}`);
                continue;
              }

              // Build issue body with Dependabot alert data
              const vuln = alert.security_vulnerability;
              const dep = alert.dependency;
              const advisory = alert.security_advisory;

              const patchedVersion = vuln.first_patched_version?.identifier || 'See advisory';
              const vulnerableRange = vuln.vulnerable_version_range || 'Unknown';

              const issueBody = `Fix ${cve} in \`${pkg}\`\n\n` +
                `**Severity:** ${advisory.severity}\n` +
                `**Package:** \`${pkg}\`\n` +
                `**Ecosystem:** ${dep.package.ecosystem}\n` +
                `**Manifest:** \`${dep.manifest_path}\`\n` +
                `**Vulnerable range:** ${vulnerableRange}\n` +
                `**Patched version:** ${patchedVersion}\n\n` +
                `**Dependabot alert:** ${alert.html_url}\n` +
                `**Advisory:** https://github.com/advisories/${advisory.ghsa_id}`;

              // Create issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Fix ${cve}: ${pkg}`,
                labels: ['dependabot-wolf'],
                body: issueBody
              });

              console.log(`Created issue #${issue.data.number} for ${cve}`);

              // Assign to Copilot using GraphQL (REST API doesn't work)
              try {
                // Get Copilot's actor ID
                const copilotQuery = `query {
                  repository(owner: "${context.repo.owner}", name: "${context.repo.repo}") {
                    suggestedActors(loginNames:"copilot", capabilities: [CAN_BE_ASSIGNED], first: 1) {
                      nodes { login ... on Bot { id } }
                    }
                  }
                }`;

                const actorResult = await github.graphql(copilotQuery);
                const copilotId = actorResult.repository.suggestedActors.nodes[0]?.id;

                if (!copilotId) {
                  console.log('Copilot not available for assignment');
                  continue;
                }

                // Assign the issue to Copilot
                const assignMutation = `mutation {
                  replaceActorsForAssignable(input: {assignableId: "${issue.data.node_id}", actorIds: ["${copilotId}"]}) {
                    assignable { ... on Issue { assignees(first: 1) { nodes { login } } } }
                  }
                }`;

                await github.graphql(assignMutation);
                console.log(`Assigned issue #${issue.data.number} to Copilot`);
              } catch (error) {
                console.log(`Could not assign to Copilot: ${error.message}`);
              }
            }
