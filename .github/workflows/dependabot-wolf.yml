name: Dependabot Wolf
on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight
  workflow_dispatch:

jobs:
  call-copilot:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPENDABOT_PAT }}
          script: |
            // Get all Dependabot alerts
            const alerts = await github.rest.dependabot.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            // Get all open PRs
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            // Find stuck alerts (alerts without Dependabot PRs)
            const stuckAlerts = alerts.data.filter(alert => {
              const pkg = alert.dependency.package.name;
              return !prs.data.some(pr =>
                pr.user.login === 'dependabot[bot]' && pr.title.includes(pkg)
              );
            });

            if (stuckAlerts.length === 0) {
              console.log('No stuck alerts');
              return;
            }

            console.log(`Found ${stuckAlerts.length} stuck alerts`);

            // For each stuck alert, create an issue if one doesn't exist
            for (const alert of stuckAlerts) {
              const cve = alert.security_advisory.cve_id || alert.security_advisory.ghsa_id;
              const pkg = alert.dependency.package.name;

              // Check if issue already exists
              const existing = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'dependabot-wolf'
              });

              if (existing.data.some(issue => issue.title.includes(cve))) {
                console.log(`Issue already exists for ${cve}`);
                continue;
              }

              // Create issue
              const advisory = alert.security_advisory.html_url || alert.html_url || 'See Dependabot alerts';
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üê∫ ${cve}: ${pkg}`,
                labels: ['dependabot-wolf'],
                body: `**${alert.security_advisory.severity}** severity\n` +
                      `**Package:** \`${pkg}\`\n` +
                      `**Advisory:** ${advisory}\n\n` +
                      `@github-copilot workspace fix this`
              });

              console.log(`Created issue for ${cve}`);
            }
