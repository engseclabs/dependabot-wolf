name: Dependabot Wolf
on:
  schedule:
    - cron: '0 0 * * *'  # Daily
  workflow_dispatch:     # Manual trigger

jobs:
  fix-stuck-alerts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      security-events: read
    steps:
      - uses: actions/checkout@v4

      - name: Find alerts Dependabot cannot fix
        id: find-alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPENDABOT_PAT }}
          script: |
            // Get all open Dependabot alerts
            const alerts = await github.rest.dependabot.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            console.log(`Found ${alerts.data.length} open Dependabot alerts`);

            // Filter for alerts without open PRs
            // These are alerts where Dependabot says:
            // "Dependabot cannot update DEPENDENCY to a non-vulnerable version"
            // Happens when:
            // - Dependency graph is complex
            // - Fix requires updating multiple dependencies
            // - Updates include major/breaking versions
            // - Impossible to upgrade without breaking the dependency graph
            const stuckAlerts = [];
            for (const alert of alerts.data) {
              const cveId = alert.security_advisory.cve_id || alert.security_advisory.ghsa_id;
              const packageName = alert.dependency.package.name;
              const isTransitive = alert.dependency.relationship === 'transitive';

              console.log(`Checking alert ${alert.number} (${cveId}): ${packageName} - ${isTransitive ? 'transitive' : 'direct'}`);

              // Check if Dependabot created a PR for this
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              });

              const hasOpenPR = prs.data.some(pr => {
                return pr.user.login === 'dependabot[bot]' &&
                       pr.title.includes(packageName);
              });

              if (!hasOpenPR) {
                console.log(`  -> Found alert where Dependabot cannot create PR: ${packageName} (${isTransitive ? 'transitive' : 'direct'})`);
                stuckAlerts.push(alert);
              } else {
                console.log(`  -> Has open PR, skipping`);
              }
            }

            console.log(`Found ${stuckAlerts.length} alerts where Dependabot cannot create PRs`);
            return stuckAlerts;

      - name: Hand off to Copilot
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPENDABOT_PAT }}
          script: |
            const stuckAlerts = ${{ steps.find-alerts.outputs.result }};

            console.log(`Handing ${stuckAlerts.length} stuck alerts to Copilot`);

            for (const alert of stuckAlerts) {
              const cveId = alert.security_advisory.cve_id || alert.security_advisory.ghsa_id;
              const packageName = alert.dependency.package.name;

              console.log(`Processing ${packageName} (${cveId})`);

              try {
                const branchName = `wolf/${cveId}`;

                // Check if branch already exists
                try {
                  await github.rest.git.getRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `heads/${branchName}`
                  });
                  console.log(`Branch ${branchName} already exists, skipping`);
                  continue;
                } catch (e) {
                  // Branch doesn't exist, continue
                }

                // Get main branch ref
                const { data: mainRef } = await github.rest.git.getRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: 'heads/main'
                });

                // Create new branch pointing to main
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/heads/${branchName}`,
                  sha: mainRef.object.sha
                });

                console.log(`Created branch ${branchName}`);

                // Get vulnerability details
                const vulnerability = alert.security_advisory.vulnerabilities[0];
                const patchedVersion = vulnerability?.first_patched_version?.identifier || 'See advisory';
                const vulnerableVersionRange = vulnerability?.vulnerable_version_range || 'Unknown';

                // Get conflicting dependencies info if available
                let conflictingDeps = '';
                if (alert.dependency.manifest_path) {
                  conflictingDeps = `\n**Manifest:** \`${alert.dependency.manifest_path}\``;
                }

                // Create PR
                const pr = await github.rest.pulls.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ðŸº Fix ${cveId}: ${packageName}`,
                  head: `wolf/${cveId}`,
                  base: 'main',
                  draft: true,
                  body: `## ðŸº Dependabot Wolf\n\n` +
                        `Dependabot got stuck. Wolf called Copilot.\n\n` +
                        `---\n\n` +
                        `**Package:** \`${packageName}\`\n` +
                        `**CVE:** ${cveId}\n` +
                        `**Severity:** ${alert.security_advisory.severity}\n` +
                        `**Vulnerable Range:** ${vulnerableVersionRange}\n` +
                        `**Patched Version:** ${patchedVersion}\n` +
                        `**Advisory:** ${alert.security_advisory.html_url}${conflictingDeps}\n\n` +
                        `### The Problem\n\n` +
                        `Dependabot said:\n` +
                        `> **"Dependabot cannot update ${packageName} to a non-vulnerable version"**\n\n` +
                        `---\n\n` +
                        `@github-copilot workspace\n\n` +
                        `Fix this security vulnerability. Dependabot couldn't figure it out - conflicting dependencies, complex dependency graph, whatever.\n\n` +
                        `**Your job:**\n` +
                        `1. Figure out what needs to be updated\n` +
                        `2. Update the dependencies (package.json, lockfiles, whatever)\n` +
                        `3. Fix any breaking changes in the code\n` +
                        `4. Make it work\n\n` +
                        `That's it. Fix it.`
                });

                console.log(`âœ“ Created PR #${pr.data.number} for ${cveId}`);
              } catch (error) {
                console.error(`âœ— Failed to create PR for ${cveId}: ${error.message}`);
              }
            }
