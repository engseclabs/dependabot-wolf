name: Dependabot Wolf
on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight
  workflow_dispatch:

jobs:
  call-copilot:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPENDABOT_PAT }}
          script: |
            // Get all Dependabot alerts
            const alerts = await github.rest.dependabot.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            // Get all open PRs
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            // Find stuck alerts (alerts without Dependabot PRs)
            const stuckAlerts = alerts.data.filter(alert => {
              const pkg = alert.dependency.package.name;
              return !prs.data.some(pr =>
                pr.user.login === 'dependabot[bot]' && pr.title.includes(pkg)
              );
            });

            if (stuckAlerts.length === 0) {
              console.log('No stuck alerts');
              return;
            }

            console.log(`Found ${stuckAlerts.length} stuck alerts`);

            // For each stuck alert, create an issue if one doesn't exist
            for (const alert of stuckAlerts) {
              const cve = alert.security_advisory.cve_id || alert.security_advisory.ghsa_id;
              const pkg = alert.dependency.package.name;

              // Check if issue already exists
              const existing = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'dependabot-wolf'
              });

              if (existing.data.some(issue => issue.title.includes(cve))) {
                console.log(`Issue already exists for ${cve}`);
                continue;
              }

              // Build detailed issue body
              const vuln = alert.security_vulnerability;
              const advisory = alert.security_advisory;
              const dep = alert.dependency;

              const patchedVersion = vuln.first_patched_version?.identifier || 'See advisory';
              const vulnerableRange = vuln.vulnerable_version_range || 'Unknown';
              const relationship = dep.relationship === 'transitive' ? ' (transitive dependency)' : '';
              const refs = advisory.references?.map(ref => `- ${ref.url}`).join('\n') || 'See advisory';

              const issueBody = `## Security Alert: ${cve}\n\n` +
                `**Severity:** ${advisory.severity}\n` +
                `**Package:** \`${pkg}\`${relationship}\n` +
                `**Manifest:** \`${dep.manifest_path}\`\n` +
                `**Vulnerable Range:** ${vulnerableRange}\n` +
                `**Patched Version:** ${patchedVersion}\n\n` +
                `### Summary\n${advisory.summary}\n\n` +
                `### Description\n${advisory.description}\n\n` +
                `### References\n${refs}\n\n` +
                `---\n\n` +
                `**Dependabot Alert:** ${alert.html_url}\n` +
                `**Advisory:** https://github.com/advisories/${advisory.ghsa_id}`;

              // Create issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üê∫ ${cve}: Fix ${pkg} vulnerability`,
                labels: ['dependabot-wolf', 'security'],
                body: issueBody
              });

              console.log(`Created issue #${issue.data.number} for ${cve}`);

              // Assign to Copilot (this is how you invoke it)
              try {
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.data.number,
                  assignees: ['copilot']
                });
                console.log(`Assigned issue #${issue.data.number} to Copilot`);
              } catch (error) {
                console.log(`Could not assign to Copilot: ${error.message}`);
              }
            }
