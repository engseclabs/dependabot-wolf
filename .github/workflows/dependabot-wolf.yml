name: Dependabot Wolf
on:
  schedule:
    - cron: '0 0 * * *'  # Daily
  workflow_dispatch:     # Manual trigger

jobs:
  fix-stuck-alerts:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      security-events: read
    steps:
      - uses: actions/checkout@v4

      - name: Call Copilot
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPENDABOT_PAT }}
          script: |
            // Get all open Dependabot alerts
            const alerts = await github.rest.dependabot.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            // Check if Dependabot created PRs
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            // Find stuck alerts (no Dependabot PR)
            const stuckAlerts = alerts.data.filter(alert => {
              const packageName = alert.dependency.package.name;
              const hasOpenPR = prs.data.some(pr =>
                pr.user.login === 'dependabot[bot]' && pr.title.includes(packageName)
              );
              return !hasOpenPR;
            });

            if (stuckAlerts.length === 0) {
              console.log('No stuck alerts found');
              return;
            }

            console.log(`Found ${stuckAlerts.length} stuck alerts`);

            // Build list of stuck alerts
            const alertList = stuckAlerts.map(alert => {
              const cveId = alert.security_advisory.cve_id || alert.security_advisory.ghsa_id;
              const pkg = alert.dependency.package.name;
              const severity = alert.security_advisory.severity;
              const url = alert.security_advisory.html_url;
              return `- **${cveId}** (${severity}): \`${pkg}\` - ${url}`;
            }).join('\n');

            // Create one issue for all stuck alerts
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸº Dependabot Wolf: ${stuckAlerts.length} stuck alert${stuckAlerts.length > 1 ? 's' : ''}`,
              labels: ['dependabot-wolf'],
              body: `Dependabot got stuck. Fix it.\n\n${alertList}\n\n@github-copilot workspace fix these vulnerabilities`
            });

            console.log(`Created issue #${issue.data.number}`)
